#!/usr/bin/env bash
### .functions - more complicated aliases, basically

## load private, non-tracked, functions
if [ -f ~/.functions_priv ]; then
  source ~/.functions_priv
fi

# about - info about current system
function about() {
  if hash archey 2>/dev/null; then
    archey $1
  else
    if [ -f /proc/version ]; then
      cat /proc/version
    else
      uname -a
    fi
  fi
}

# get random local port
function get_rand_port() {
  netstat -aln | awk '
    $6 == "LISTEN" {
      if ($4 ~ "[.:][0-9]+$") {
        split($4, a, /[:.]/);
        port = a[length(a)];
        p[port] = 1
      }
    }
    END {
      for (i = 3000; i < 65000 && p[i]; i++){};
      if (i == 65000) {exit 1};
      print i
    }
  '
}

# simple http servers for local directory in various flavors
function httphp() {
  rport=$(get_rand_port);
  open http://localhost:$rport;
  php -S 127.0.0.1:$rport;
}
function httpy() {
  rport=$(get_rand_port);
  open http://localhost:$rport;
  python -m SimpleHTTPServer $rport;
}
function httruby() {
  rport=$(get_rand_port);
  open http://localhost:$rport;
  ruby -run -e httpd . -p $rport;
}

# dice rolls
function roll {
 if [ $# -ge 1 ]; then
   echo $(($RANDOM % $1 + 1))
 else
   echo $(($RANDOM % 2))
 fi
}

# make a directory and change into it
function mdcd {
 if [ ! -d "$1" ]; then
   if [ ! -L "$1" ]; then
     mkdir $1
     eval cd $1
   fi
 else
   eval cd $1
 fi
}

# drupal
# install drush
function drushinstall {
  php -r "readfile('https://s3.amazonaws.com/files.drush.org/drush.phar');" > drush;chmod +x drush;mv drush /usr/local/bin;
}
## modules
function dpcheck() {
  root_dir=.
  if [ $# -ge 1 ]; then
    root_dir=$1
  fi
  phpcs --standard=Drupal --extensions='php,module,inc,install,test,profile,theme,js,css,info,txt,md' $root_dir
}
function dpfix() {
  root_dir=.
  if [ $# -ge 1 ]; then
    root_dir=$1
  fi
  phpcbf --standard=Drupal --extensions='php,module,inc,install,test,profile,theme,js,css,info,txt,md' $root_dir
}

# jekyll startup script
function jsw {
  (jekyll serve -w --drafts) | while read line; do
    [[ $line =~ "Server running" ]] && open http://127.0.0.1:4000
  done
}

# os x toggle hidden files in finder
function hiddentoggle {
  stat=$(defaults read com.apple.Finder AppleShowAllFiles)
  if [ "$stat" = "YES" ]; then
    defaults write com.apple.Finder AppleShowAllFiles NO
  else
    defaults write com.apple.Finder AppleShowAllFiles YES
  fi
  killall Finder
}

# make it snow in your terminal
# source: http://climagic.org/coolstuff/let-it-snow.html
function snow {
  export LINES COLUMNS;
  clear;
  while :;
  do echo $LINES $COLUMNS $(($RANDOM%$COLUMNS));
  sleep 0.1;
  done|gawk '{a[$3]=0;for(x in a) {o=a[x];a[x]=a[x]+1;printf "\033[%s;%sH ",o,x; printf "\033[%s;%sH*\033[0;0H",a[x],x;}}'
}

# color show in your terminal
# source: https://twitter.com/climagic/status/817405740772184065
function colors {
  yes "$(seq 16 231)" | while read i;
  do printf "\x1b[48;5;${i}m\n";
  sleep .02;
  done
}

# change tab color
function tab-color {
  case $1 in
    green)
    echo -n -e "\033]6;1;bg;red;brightness;57\a"
    echo -n -e "\033]6;1;bg;green;brightness;197\a"
    echo -n -e "\033]6;1;bg;blue;brightness;77\a"
    ;;
    red)
    echo -n -e "\033]6;1;bg;red;brightness;270\a"
    echo -n -e "\033]6;1;bg;green;brightness;60\a"
    echo -n -e "\033]6;1;bg;blue;brightness;83\a"
    ;;
    orange)
    echo -n -e "\033]6;1;bg;red;brightness;227\a"
    echo -n -e "\033]6;1;bg;green;brightness;143\a"
    echo -n -e "\033]6;1;bg;blue;brightness;10\a"
    ;;
    blue)
    echo -n -e "\033]6;1;bg;red;brightness;30\a"
    echo -n -e "\033]6;1;bg;green;brightness;144\a"
    echo -n -e "\033]6;1;bg;blue;brightness;255\a"
    ;;
    purple)
    echo -n -e "\033]6;1;bg;red;brightness;147\a"
    echo -n -e "\033]6;1;bg;green;brightness;112\a"
    echo -n -e "\033]6;1;bg;blue;brightness;219\a"
    ;;
    yellow)
    echo -n -e "\033]6;1;bg;red;brightness;255\a"
    echo -n -e "\033]6;1;bg;green;brightness;255\a"
    echo -n -e "\033]6;1;bg;blue;brightness;0\a"
    ;;
    reset)
    echo -n -e "\033]6;1;bg;red;brightness;255\a"
    echo -n -e "\033]6;1;bg;green;brightness;255\a"
    echo -n -e "\033]6;1;bg;blue;brightness;255\a"
    ;;
  esac
}
# make ssh tabs red
function color-ssh {
  tab-color red
  ssh $1
  tab-color reset
}
alias ssh=color-ssh

# Set iTerm2 tab titles
tabTitle() { echo -ne "\033]0;"$*"\007"; }

# Always list directory contents and set title upon 'cd'
function tab-cd() {
  builtin cd "$@";
  ls -lFah;
  tabTitle ${PWD##*/};
}
